var W,P,v,S,T,K,E,F,U,te,M,x,z=(r,o,t)=>{if(!o.has(r))throw TypeError("Cannot "+t)},p=(r,o,t)=>{if(o.has(r))throw TypeError("Cannot add the same private member more than once");o instanceof WeakSet?o.add(r):o.set(r,t)},C=(r,o,t)=>(z(r,o,"access private method"),t);import{Events as c,Requests as s}from"./core-consts";import{jsonDescriptor as B}from"./bundle";import{CryptManager as D}from"./cryptManager";import q from"./chatextra";const u=new D;let le={};const $=require("protobufjs/light"),l=$.Root.fromJSON(B);let b=l.lookupType("csproto.webclient.WebPayload");b.Type={EVENT:0,REQUEST:1,REPLY:2};let R=l.lookupType("csproto.webclient.WebRequest"),w=l.lookupType("csproto.webclient.WebStateEvent"),L=l.lookupType("csproto.webclient.WebAlertEvent"),re=l.lookupType("csproto.webclient.WebCallEvent"),N=l.lookupType("csproto.webclient.WebAuthEvent"),y=l.lookupType("csproto.webclient.WebChatEvent"),V=l.lookupType("csproto.webclient.WebVerifyEvent"),ie=l.lookupType("csproto.webclient.WebAvatarEvent"),he=l.lookupType("csproto.webclient.WebAccountEvent"),H=l.lookupType("csproto.webclient.WebContact"),j=l.lookupType("csproto.webclient.WebContacts"),I=l.lookupType("csproto.webclient.WebAccountDetails"),A=l.lookupType("csproto.webclient.WebChat"),O=l.lookupType("csproto.webclient.WebChats"),Q=l.lookupType("csproto.webclient.WebMessage"),Y=l.lookupType("csproto.webclient.WebMessages"),J=l.lookupType("csproto.webclient.WebFile"),_=l.lookupType("csproto.webclient.WebCalls"),X=l.lookupType("csproto.webclient.WebExtra"),Z=l.lookupType("csproto.webclient.WebCredentials");const k=64e3;function G(r){for(var o=[],t=0;t<r.length;t++){var e=r[t]<0?r[t]+256:r[t];o.push((e>>>4).toString(16)),o.push((15&e).toString(16))}return o.join("")}function de(r){for(var o=[],t=0;t<r.length;t+=2)o.push(parseInt(r.substr(t,2),16));return o}class ee{constructor(){p(this,W),p(this,v),p(this,T),p(this,E),p(this,U),p(this,M),this.wscs=null,this.messageCollector={}}async connect(o){return await u.initialize({}),console.log("-- cryptManager.initialize",u.publicKey()),this.wscs=new WebSocket(o),this.wscs.binaryType="arraybuffer",new Promise(t=>{this.wscs.onopen=e=>{console.log("-- onopen",e),this.onready=function(){console.log("-- onready"),t(!0)},C(this,E,F).call(this)},this.wscs.onmessage=e=>{C(this,W,P).call(this,e)},this.wscs.onerror=e=>{console.log("-- wscsClient onerror",e),t(!1)},this.wscs.onclose=e=>{console.log("-- wscsClient onclose",e)}})}send(o,t){let e;if(t){const g=R.create(t),d=R.encode(g).finish();console.log(`-- req ${d.length}, webreq[${g}], req=${t}`),e=u.encrypt(this.senderKey,d),console.log("-- req 2",e,this.senderKey)}const n=e?e.length:0;let a=n>k?n/k:0;n%k&&a++,console.log(`-- send 2: ${n} [${a}]`);let i=0,h=0;do{const g=e?e.subarray(i,i+k):void 0,d=b.create({type:b.Type.REQUEST,action:o,cryptoBox:g,token:this.myToken,fragment:h,fragmentCount:a});console.log(`-- send ${o} [${h}][${i}]`,d);const m=b.encode(d).finish();this.wscs.send(m),i+=k,h++}while(h<a)}buildWebContact(o,t,e){return H.create({contactId:o,name:t,chatId:e})}buildWebAccountDetails(o,t,e,n){let a={};return o&&(a.name=o),t&&(a.email=t),e&&(a.phone=e),n&&(a.avatar=n),I.create(a)}buildWebExtra(o){let t=[];for(let e in o){let n=X.create({key:e,value:o[e]});t.push(n)}return console.log("-- buildWebExtra",t),t}authorize(o,t){console.log("-- authorize:",o,t);const e=Z.create({login:o,password:t});return new Promise(n=>{this.onuserauthorized=function(a){console.log("-- onuserauthorized",a),n(a)},this.send(s.Login,{credentials:e})})}addContact(o,t){return console.log("-- addContact:",o,t),new Promise(async e=>{const n=await this.verifyContact(o);if(0!=n.result)e(n.result);else{const i=this.buildWebContact(o,t||n.name);this.send(s.AddContact,{contact:i}),e(0)}})}verifyContact(o){console.log("-- verifyContact:",o);const t=this.buildWebContact(o);return new Promise(e=>{this.onverifyusercomplete=function(n){e(n)},this.send(s.VerifyContact,{contact:t})})}getContacts(){return new Promise(o=>{this.ongetcontacts=function(t){o(t)},this.send(s.GetContacts)})}createChat(o){return new Promise(t=>{this.oncreatechat=e=>t(e.chatId),this.send(s.CreateChat,{users:o})})}getChats(){return new Promise(o=>{this.ongetchats=function(t){o(t)},this.send(s.GetChats)})}getChatMessage(o,t){return new Promise(e=>{this.ongetchatmessage=n=>e(n),this.send(s.GetChatMessage,{chatId:o,messageId:t})})}sendMessage(o,t,e,n){return e||(e=0),new Promise(a=>{this.send(s.SendChatMessage,{chatId:o,content:t,type:e,extra:n}),a(!0)})}sendFileMessage(o,t,e){return console.log("-- sendChatFile",{chatId:o,type:e}),new Promise(n=>{const a=this;for(let i=0;i<t.length;i++){const h=t[i],g=new FileReader;g.onload=d=>{let m=btoa(d.target.result),f=new q;f.setOriginalName(h.name),f.setFileSize(h.size),f=a.buildWebExtra(f),console.log(m),a.send(s.SendChatFile,{chatId:o,file:m,type:e,extra:f})},g.readAsBinaryString(h)}n()})}}W=new WeakSet,P=function(o){const t=new Uint8Array(o.data),e=b.decode(t);if(console.debug("-- recvd",e.type,e.action,e.fragment,e.fragmentCount),e.fragmentCount>0){let n=e.action;if(this.messageCollector[n]||(this.messageCollector[n]={}),this.messageCollector[n][e.fragment]=e.cryptoBox,e.fragment!=e.fragmentCount-1)return;let i=new Uint8Array;for(let h=0;h<e.fragmentCount;h++){const g=this.messageCollector[n][h],d=new Uint8Array(i.length+g.length);d.set(i),d.set(g,i.length),i=d}e.cryptoBox=i,this.messageCollector[n]={}}0==e.cryptoBox.length&&e.publicKey&&e.publicKey.length>0?(console.log("-- store user key:",G(e.publicKey)),this.senderKey=e.publicKey,this.senderToken=e.token,this.onready()):e.type==b.Type.EVENT?C(this,v,S).call(this,e):e.type==b.Type.REPLY?C(this,T,K).call(this,e):console.error("-- unknown payload: ",e)},v=new WeakSet,S=function(o){const t=u.decrypt(this.senderKey,o.cryptoBox);console.debug("-- payload event:",o.action,"bytes",t.length);let e=null;switch(o.action){case c.UserAuthorized:e=N.decode(t),console.log("-- userAuthorized",e),this.onuserauthorized(e);break;case c.StatusChanged:e=w.decode(t),this.onstatuschanged&&this.onstatuschanged(e);break;case c.ChatChanged:case c.ChatDetailsChanged:case c.ChatMessagesRemoved:case c.ChatMessageReceived:case c.ChatMessageSendingDone:case c.FileSent:case c.FileReceived:case c.FileProgress:e=y.decode(t),e.action=o.action,console.log("-- chatchanged",e),this.onchatchanged&&this.onchatchanged(e);break;case c.ChatTtlChanged:e=y.decode(t),this.onchatttlchanged&&this.onchatttlchanged(e);break;case c.ChatUnreadChanged:e=y.decode(t),this.onchatunreadchanged&&this.onchatunreadchanged(e);break;case c.ChatTtlMessageProgress:e=y.decode(t),this.onchatttlmessageprogress&&this.onchatttlmessageprogress(e);break;case c.ChatTypingEvent:e=y.decode(t),this.onchattypingupdated&&this.onchattypingupdated(e);break;case c.ChatMessageUpdated:e=y.decode(t),this.onchatmessageupdated&&this.onchatmessageupdated(e);break;case c.ConferenceStarted:case c.ConferenceEnded:case c.ConferenceSuspended:case c.ConferenceResumed:case c.IncomingCall:case c.RecentChanged:case c.UserListChanged:break;case c.ShowMessage:e=L.decode(t),this.onshowmessage&&this.onshowmessage(e);break;case c.BlockUserComplete:e=w.decode(t),console.log("-- blockUserComplete",e),this.onblockusercomplete&&this.onblockusercomplete(e);break;case c.UnblockUserComplete:e=w.decode(t),console.log("-- unblockUserComplete",e),e.id=e.contactId,this.onunblockusercomplete&&this.onunblockusercomplete(e);break;case c.UnblockUsersComplete:e=w.decode(t),console.log("-- unblockUsersComplete",e),this.onunblockallcomplete&&this.onunblockallcomplete(e);break;case c.AccountAvatarSet:break;case c.VerifyUserComplete:if(!this.onverifyusercomplete)return;e=V.decode(t),console.log("-- verifyUserComplete",e),this.onverifyusercomplete({id:e.contactId,result:e.result,name:e.name,fingerprint:e.fingerprint,avatar:e.avatar.byteLength>0?""+btoa(String.fromCharCode(...e.avatar)):""})}},T=new WeakSet,K=function(o){console.debug("-- payload req:",o.action);const t=u.decrypt(this.senderKey,o.cryptoBox);let e;switch(o.action){case s.GetContacts:case s.GetBlockedContacts:e=t.length>0?j.decode(t):{contacts:[]};break;case s.GetChats:e=t.length>0?O.decode(t):{chats:[]},console.log("-- GetChats",e);break;case s.GetChatMessages:e=t.length>0?Y.decode(t):{messages:[]},console.log("-- GetChatMessages",e);break;case s.GetChatMessage:e=t.length>0?Q.decode(t):{},console.log("-- GetChatMessage",e);break;case s.GetRecentCalls:e=t.length>0?_.decode(t):{calls:[]},console.log("-- GetRecentCalls");break;case s.GetUserProfile:console.error("-- GetUserProfile");break;case s.DecodeFile:e=t.length>0?J.decode(t):{data:new Uint8Array};break;case s.CreateChat:case s.RestoreDraft:case s.GetChatTtl:case s.GetChatUnreadCount:case s.GetUnreadCount:case s.OpenSingleChat:e=t.length>0?A.decode(t):{},console.log("-- chat action",o.action,e);break;case s.RestoreDraft:e=t.length>0?A.decode(t):{};break;case s.ReadFile:console.error("-- ReadFile");break;case s.Ping:console.log("-- ping received"),this.pingCount=0,e={};break;default:console.log("-- payload event:",o)}e&&(e.action=o.action),C(this,M,x).call(this,e)},E=new WeakSet,F=function(){const o=b.create({type:b.Type.REQUEST,action:s.WebClientAuth,publicKey:u.key.publicKey}),t=b.encode(o).finish();console.log("-- sendPublicKey:",G(t)," ",u.publicKey()),this.wscs.send(t)},U=new WeakSet,te=function(){this.pingCount=0,this.pingTid=setInterval(()=>{this.pingCount++,this.pingCount>=3?(clearInterval(this.pingTid),console.error("-- you lost connection")):(this.send(s.Ping),console.log("-- ping",this.pingCount))},2e4)},M=new WeakSet,x=function(o){switch(o.action){case s.GetContacts:this.ongetcontacts&&this.ongetcontacts(o.contacts);break;case s.GetChats:this.ongetchats&&this.ongetchats(o.chats);break;case s.CreateChat:console.debug("-- CreateChat",o),this.oncreatechat&&this.oncreatechat(o);break;case s.GetChatMessage:console.debug("-- GetChatMessage",o),this.ongetchatmessage&&this.ongetchatmessage(o)}};export{ee as WebClient};